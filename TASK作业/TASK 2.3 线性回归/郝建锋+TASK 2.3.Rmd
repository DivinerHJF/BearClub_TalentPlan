---
title: "Task 2.3 线性回归练习"
author: "郝建锋"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
---

##任务一：数据读入与检查
###1.1 数据导入
```{r, message = FALSE, warning=FALSE}
dat0 <- read.csv("D:/Desktop/housing.csv", stringsAsFactors=F)
```





###1.2 检查数据
```{r, message = FALSE, warning=FALSE}
summary(dat0)           # 查看数据概况
```
数据共包含12个变量，其中因变量是单位面积房价。由于经度、纬度、小区名称和所属街区四个变量与因变量关系不大，本文不予考虑。本文选取的自变量共有7个，其中3个为连续型，4个为离散型。所有变量具体情况如下表所示：

| 变量名称| 变量类型| 详细说明| 取值范围|
| :-----: | :-----: | :-----: | :-----: |
| 单位面积房价| 连续型| 单位：万元/平方米|1.83~14.98|
| 房屋面积    | 连续型| 单位：平方米|30.06~299.00|
| 卧室数量    | 连续型| 单位：个|1~5|
| 客厅数量    | 连续型| 单位：个|0~3|
| 房屋楼层    | 离散型| 3个水平|低/中/高楼层|
| 所属城区    | 离散型| 6个水平|朝阳、海淀、东城、西城、丰台、石景山|
| 是否学区房  | 离散型| 2个水平|1代表临近地铁，0代表不临近地铁|
| 是否临近地铁| 离散型| 2个水平|1代表学区房，0代表非学区房|

为了深入分析各因素对二手房房价的影响，本文接下来将建立单位面积房价的回归模型，使用定量化的方式更为精确地刻画各因素的影响作用大小。

##任务二：简单线性模型

以价格(price)为因变量，房屋面积(AREA)和城区(CATE)为自变量，建立简单线性回归模型如下：
```{r, message = FALSE, warning=FALSE}
lm_a <- lm(price ~ AREA + CATE, data = dat0)
summary(lm_a)           # 展示回归结果
```
从输出结果可以看出，**模型整体**调整的$R^2$=0.52（p-值<0.0001），不是很高，说明有很多的因素还没被当前所选的解释变量覆盖，模型还能进一步优化。  
所有的**解释变量**都高度显著（p-值<0.0001），正负号代表着这个变量对价格的影响是正向还是反向，当控制其他因素不变时：  

* 房屋面积的增加会带来单位面积房价的降低；  
* 对于城区这一变量，单位面积房价由高到低依次为西城、东城、海淀、丰台、石景山，其中西城比石景山每平米平均高出4.54万元。


##任务三：复杂线性模型
###3.1 数据处理
将客厅数(halls)变量重新整理成一个新变量style，记录是否有厅：
```{r, message = FALSE, warning=FALSE}
# 创建新变量style记录是否有厅
dat1 <- dat0
dat1$style <- c("有厅")
dat1$style[which(dat1$halls==0)] <- c("无厅")
# 查看新变量的频数分布情况
table(dat1$style)
```

###3.2 建立模型
现在，运行一个更加复杂的回归模型，命名为lm_b：
```{r, message = FALSE, warning=FALSE}
lm_b <- lm(price ~ CATE + school + subway + style + 
             floor + bedrooms + AREA, data = dat1)
summary(lm_b)
```
新的回归模型调整的$R^2$=0.59（p-值<0.0001），明显优于上面建立的简单线性模型，模型的拟合程度尚可接受。但任务并没有完成，接下来还需要通过模型诊断来判断上述模型还存在某些问题。

##任务四：复杂模型的诊断
对回归模型lm_b做诊断:
```{r, message = FALSE, warning=FALSE}
par(mfrow = c(2, 2))
plot(lm_b,which=c(1:4))   # 绘制相关图形进行诊断
```

右下角图中的Cook距离表现正常，表明没有异常点。  
从左上图可以看出，随着预测值的增大，残差的波动也随之增大，右上角的Q-Q图也产生了偏移，这说明模型可能存在异方差问题。为了解决这一问题，目前公认较好的方法是对因变量单位面积房价做对数处理。  
  
接下来需要看一下自变量的方差膨胀因子：
```{r, message = FALSE, warning=FALSE}
library(car)              # 需要用car包中vif函数
vif(lm_b)                 # 计算方差膨胀因子
```
发现所有变量的方差膨胀因子都没有超过10，可以认为自变量之间多重共线性不高。

##任务五：对数线性模型
在模型lm_b的基础上，以对数房价为因变量，建立对数线性回归模型，命名为lm_c：
```{r, message = FALSE, warning=FALSE}
lm_c <- lm(log(price) ~ CATE + school + subway + style + 
             floor + bedrooms + AREA, data = dat1)
summary(lm_c)
```
可以看到，模型仍然是显著的（p-值<0.0001），调整的$R^2$=0.6079，模型的拟合程度略有上升。  
需要注意的是，与线性模型不同，对数线性模型的系数估计值应解读为“增长率”，即某自变量变动一个单位，因变量变化的百分比。因此，从上面输出结果可以得到以下结论：在控制其他因素不变的情况下，  

* 不同城区单位面积房价由高到低依次为：西城、东城、海淀、丰台和石景山；
* 学区房比非学区房的单位面积房价平均贵17.19%；
* 地铁房比非地铁房的单位面积房价平均贵12.82%；
* 高层房屋单位面积房价最低，其次为中层，低层房屋单位面积房价最高；
* 有客厅的房子单位面积房价更高，平均贵2.75%；
* 卧室数每增加一间，单位面积房价平均增加1.40%；
* 房屋面积的增加会带来单位面积房价的降低。

##任务六：对数线性交互模型

在lm_c的基础上，加入城区*学区的交互作用，将这个模型命名为lm_d：
```{r, message = FALSE, warning=FALSE}
lm_d <- lm(log(price) ~ CATE*school + subway + style + 
             floor + bedrooms + AREA, data = dat1)
summary(lm_d)
```
可以看到，考虑交互效应后，模型仍然是显著的（p-值<0.0001），且模型的拟合效果略有提高（调整后的$R^2$=0.6108）。  
一个明显的变化是：在石景山区，**城区\*学区**变量系数为负，所以得出结论，在石景山区，学区房比非学区房的单位面积房价低。推测出现这一结果的原因有二：1、石景山区样本中学区房比例过低；2、石景山区的学区资源相对较差。
